// Generated by CoffeeScript 1.4.0
(function() {
  var Sketch, abs, colormap, dist, dummyEasel, max, min, pow, print, sqr, sqrt, sum, _ref,
    __slice = [].slice;

  abs = function(n) {
    return Math.abs(n);
  };

  min = function() {
    var n;
    n = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return Math.min.apply(Math, n);
  };

  max = function() {
    var n;
    n = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return Math.max.apply(Math, n);
  };

  pow = function(n, p) {
    return Math.pow(n, p);
  };

  sqr = function(n) {
    return Math.pow(n, 2);
  };

  sqrt = function(n) {
    return Math.sqrt(n);
  };

  sum = function(o) {
    if (o.length) {
      return o.reduce(function(a, b) {
        return a + b;
      });
    } else {
      return "";
    }
  };

  dist = function(a, b) {
    var ai, i;
    return sqrt(sum((function() {
      var _i, _len, _results;
      _results = [];
      for (i = _i = 0, _len = a.length; _i < _len; i = ++_i) {
        ai = a[i];
        _results.push(sqr(ai - (b ? b[i] : 0)));
      }
      return _results;
    })()));
  };

  print = function(o) {
    return console.log(o);
  };

  colormap = d3.scale.linear().domain([0, 0.166, 0.33, 0.5, 0.66, 0.83, 1 - 1e-6, 1, 2, 100]).range([d3.hsl("hsl(244, 100%, 39%)"), d3.hsl("hsl(214, 91%, 50%)"), d3.hsl("hsl(186, 100%, 43%)"), d3.hsl("hsl(160, 84%, 50%)"), d3.hsl("hsl(100, 100%, 50%)"), d3.hsl("hsl(60, 100%, 50%)"), d3.hsl("hsl(33, 96%, 50%)"), d3.hsl("hsl(0, 100%, 50%)"), d3.hsl("hsl(0, 100%, 30%)"), d3.hsl("hsl(0, 100%, 20%)")]);

  if ((_ref = window.tacit) == null) {
    window.tacit = {};
  }

  window.tacit.colormap = colormap;

  dummyEasel = (function() {

    function dummyEasel(versions, i) {
      this.versions = versions;
      this.i = i;
      null;
    }

    dummyEasel.prototype.mouseDown = function(easel, eventType, mouseLoc, object) {
      return false;
    };

    dummyEasel.prototype.allowPan = function() {
      return false;
    };

    dummyEasel.prototype.mouseUp = function(easel, eventType, mouseLoc, object) {
      return false;
    };

    dummyEasel.prototype.mouseMove = function(easel, eventType, mouseLoc, object) {
      return false;
    };

    return dummyEasel;

  })();

  Sketch = (function() {

    function Sketch(pad, htmlLoc, structure, height, width, scale, translate, feapad) {
      var autozoom, baseLineBox, deasel, easel, gridBox, htmlObj, mousedn,
        _this = this;
      this.pad = pad;
      if (htmlLoc == null) {
        htmlLoc = "body";
      }
      this.height = height;
      this.width = width;
      if (feapad == null) {
        feapad = true;
      }
      this.showforce = true;
      this.showzero = false;
      this.transitioning = false;
      this.drawscale = 5;
      htmlObj = d3.select(htmlLoc);
      if (structure != null) {
        autozoom = true;
        this.structure = structure;
      } else {
        autozoom = false;
        this.structure = new tacit.Structure;
      }
      this.svg = htmlObj.append("svg:svg").attr("width", this.width).attr("height", this.height).attr("pointer-events", "all");
      if (autozoom && (scale != null) && (translate != null)) {
        autozoom = false;
      }
      this.translate = [10, 10];
      this.scale = 0.00001;
      this.nodeSize = 9;
      this.easel = this.pad.easel;
      easel = this.pad.easel;
      this.zoomer = d3.behavior.zoom().on("zoom", function() {
        if (easel.allowPan()) {
          return _this.rescale();
        }
      });
      mousedn = function() {
        return _this.blank.call(d3.behavior.zoom().on("zoom"), function() {
          if (easel.allowPan()) {
            return _this.rescale();
          }
        });
      };
      this.selectedNodes = [];
      this.selectedLinks = [];
      this.blank = this.svg.append("svg:g").attr("transform", "translate(0," + height + ") scale(1,-1)").append("svg:g").call(this.zoomer).on("dblclick.zoom", null).append("svg:g").on("mousedown", mousedn);
      this.background = this.blank.append("svg:g").on("mousedown", function(d) {
        return easel.mouseDown(easel, "background", d3.mouse(this), d);
      }).on("mousemove", function(d) {
        return easel.mouseMove(easel, "background", d3.mouse(this), d);
      }).on("mouseup", function(d) {
        return easel.mouseUp(easel, "background", d3.mouse(this), d);
      });
      this.rect = this.background.append("svg:rect").attr("x", -this.width / 2).attr("y", -this.height / 2).attr("width", this.width).attr("height", this.height).attr("fill", "url(#grid)");
      this.baseLine = this.background.append("svg:line").attr("x1", -200).attr("y1", 0).attr("x2", 300).attr("y2", 0).attr("stroke", "#3d3130").attr("stroke-width", 0.5);
      if (!window.keysCaptured) {
        d3.select(window).on("keydown", function() {
          return easel.keyDown(easel, "window", d3.event.keyCode);
        });
        window.keysCaptured = true;
      }
      this.fixed = this.blank.selectAll(".fixed");
      this.nodes = this.blank.selectAll(".node");
      this.links = this.blank.selectAll(".link");
      this.selectablelinks = this.blank.selectAll(".selectablelinks");
      this.forces = this.blank.selectAll(".force");
      this.grads = this.blank.selectAll(".grad");
      this.dragline = this.blank.append("line").attr("class", "dragline").attr("x1", 0).attr("x2", 0).attr("y1", 0).attr("y2", 0);
      if (autozoom != null) {
        this.defaultZoom();
      }
      gridBox = $('input[name=grid]');
      gridBox.prop('checked', true);
      baseLineBox = $('input[name=baseLine]');
      baseLineBox.prop('checked', true);
      if (feapad && !window.feapad) {
        window.feapad = true;
        deasel = new dummyEasel();
        this.feapad = new tacit.Pad(deasel, "#FEAview", height, width, this.structure, feapad = false);
        this.feapad.showforce = false;
        window.feapadpad = this.feapad;
      }
    }

    Sketch.prototype.defaultZoom = function() {
      var d, list, maxs, means, mins, n, scale, translate, _i, _len, _ref1, _ref2, _ref3;
      if ((_ref1 = window.scalemult) == null) {
        window.scalemult = 0.6;
      }
      _ref2 = [{}, {}, {}], mins = _ref2[0], maxs = _ref2[1], means = _ref2[2];
      _ref3 = ["x", "y", "z"];
      for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
        d = _ref3[_i];
        list = (function() {
          var _j, _len1, _ref4, _results;
          _ref4 = this.structure.nodeList;
          _results = [];
          for (_j = 0, _len1 = _ref4.length; _j < _len1; _j++) {
            n = _ref4[_j];
            _results.push(n[d]);
          }
          return _results;
        }).call(this);
        mins[d] = min.apply(null, list);
        maxs[d] = max.apply(null, list);
      }
      scale = window.scalemult * min(this.width / (maxs.x - mins.x), this.height / (maxs.y - mins.y));
      translate = [this.width / 2 - scale * (maxs.x + mins.x) / 2, this.height / 2 - scale * (maxs.y + mins.y) / 2];
      return this.rescale(translate, scale);
    };

    Sketch.prototype.rescale = function(translate, scale, draw, force) {
      var d, list, maxs, means, mins, n, outBottom, outLeft, outRight, outTop, _i, _len, _ref1, _ref2;
      if (draw == null) {
        draw = true;
      }
      if (force == null) {
        force = true;
      }
      if (translate == null) {
        translate = d3.event.translate;
      }
      if (scale == null) {
        scale = d3.event.scale;
      }
      translate = [translate[0] / scale, translate[1] / scale];
      _ref1 = [{}, {}, {}], mins = _ref1[0], maxs = _ref1[1], means = _ref1[2];
      _ref2 = ["x", "y", "z"];
      for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
        d = _ref2[_i];
        list = (function() {
          var _j, _len1, _ref3, _results;
          _ref3 = this.structure.nodeList;
          _results = [];
          for (_j = 0, _len1 = _ref3.length; _j < _len1; _j++) {
            n = _ref3[_j];
            _results.push(n[d]);
          }
          return _results;
        }).call(this);
        mins[d] = min.apply(null, list);
        maxs[d] = max.apply(null, list);
      }
      outLeft = mins.x + translate[0] < -this.translate[0];
      outBottom = mins.y + translate[1] < -this.translate[1];
      outRight = maxs.x + translate[0] > 6 / this.scale * (this.width / this.scale - this.translate[0]);
      outTop = maxs.y + translate[1] > 6 / this.scale * (this.height / this.scale - this.translate[1]);
      if (force || !(outLeft || outRight || outBottom || outTop)) {
        this.rect.attr("x", -translate[0]).attr("y", -translate[1]).attr("width", this.width / scale).attr("height", this.height / scale);
        this.scale = scale;
        this.translate = translate;
        this.blank.attr("transform", "scale(" + this.scale + ") translate(" + this.translate + ")");
        if (draw) {
          this.resize();
        }
      }
      if (scale < this.scale) {
        this.scale = scale;
        this.blank.attr("transform", "scale(" + this.scale + ") translate(" + this.translate + ")");
      }
      this.zoomer.translate([this.translate[0] * this.scale, this.translate[1] * this.scale]);
      return this.zoomer.scale(this.scale);
    };

    Sketch.prototype.updateDrawing = function() {
      var easel, n;
      easel = this.pad.easel;
      this.selectablelinks = this.selectablelinks.data(this.structure.beamList);
      this.selectablelinks.enter().insert("line", ".node").attr("class", "selectablelinks").on("mousedown", function(d) {
        return easel.mouseDown(easel, "beam", d3.mouse(this), d);
      }).on("mousemove", function(d) {
        return easel.mouseMove(easel, "beam", d3.mouse(this), d);
      }).on("mouseup", function(d) {
        return easel.mouseUp(easel, "beam", d3.mouse(this), d);
      });
      this.selectablelinks.exit().transition().attr("r", 0).remove();
      this.links = this.links.data(this.structure.beamList);
      this.links.enter().insert("line", ".node").attr("class", "link").attr("stroke", "#9c7b70").on("mousedown", function(d) {
        return easel.mouseDown(easel, "beam", d3.mouse(this), d);
      }).on("mousemove", function(d) {
        return easel.mouseMove(easel, "beam", d3.mouse(this), d);
      }).on("mouseup", function(d) {
        return easel.mouseUp(easel, "beam", d3.mouse(this), d);
      });
      this.links.exit().transition().attr("r", 0).remove();
      this.forces = this.forces.data(this.structure.nodeList);
      this.forces.enter().insert("line").attr("class", "force").attr("stroke-width", 0).attr("marker-end", "url(#brtriangle)").on("mousedown", function(d) {
        return easel.mouseDown(easel, "force", d3.mouse(this), d);
      }).on("mousemove", function(d) {
        return easel.mouseMove(easel, "force", d3.mouse(this), d);
      }).on("mouseup", function(d) {
        return easel.mouseUp(easel, "force", d3.mouse(this), d);
      });
      this.forces.exit().remove();
      this.grads = this.grads.data(this.structure.nodeList);
      this.grads.enter().insert("line").attr("class", "grad").attr("stroke-width", 0).attr("marker-end", "url(#ptriangle)").on("mousedown", function(d) {
        return easel.mouseDown(easel, "grad", d3.mouse(this), d);
      }).on("mousemove", function(d) {
        return easel.mouseMove(easel, "grad", d3.mouse(this), d);
      }).on("mouseup", function(d) {
        return easel.mouseUp(easel, "grad", d3.mouse(this), d);
      });
      this.grads.exit().remove();
      this.nodes = this.nodes.data(this.structure.nodeList);
      this.nodes.enter().insert("circle").classed("node", true).classed("fixed", function(d) {
        return d.fixed.x || d.fixed.y;
      }).classed("immovable", function(d) {
        return d.immovable === true;
      }).attr("r", this.nodeSize / this.scale / 2).on("mousedown", function(d) {
        return easel.mouseDown(easel, "node", d3.mouse(this), d);
      }).on("mousemove", function(d) {
        return easel.mouseMove(easel, "node", d3.mouse(this), d);
      }).on("mouseup", function(d) {
        return easel.mouseUp(easel, "node", d3.mouse(this), d);
      }).transition().duration(80).ease("elastic").attr("r", this.nodeSize / this.scale);
      this.nodes.exit().transition().attr("r", 0).remove();
      this.fixed = this.fixed.data((function() {
        var _i, _len, _ref1, _results;
        _ref1 = this.structure.nodeList;
        _results = [];
        for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
          n = _ref1[_i];
          if (n.fixed.x || n.fixed.y) {
            _results.push(n);
          }
        }
        return _results;
      }).call(this));
      this.fixed.enter().insert("path").attr("d", function(d) {
        return "M " + (-5 + d.x) + "," + (-3 + d.y) + " l 5,8.6 l 5,-8.6 Z";
      }).attr("class", "fixed").on("mousedown", function(d) {
        return easel.mouseDown(easel, "node", d3.mouse(this), d);
      }).on("mousemove", function(d) {
        return easel.mouseMove(easel, "node", d3.mouse(this), d);
      }).on("mouseup", function(d) {
        return easel.mouseUp(easel, "node", d3.mouse(this), d);
      });
      return this.slowDraw();
    };

    Sketch.prototype.fea = function() {
      var cost, genhelper,
        _this = this;
      if (this.pad.easel.weightDisplay != null) {
        cost = Math.round(this.structure.lp.obj / 100);
        if (cost !== 1000) {
          this.pad.easel.weightDisplay.innerText = "\$" + cost;
          if (window.triggers.solve != null) {
            window.triggers.solve();
          }
          if (window.helper != null) {
            window.helper.attr("opacity", 0);
          }
        } else {
          this.pad.easel.weightDisplay.innerHTML = "$&infin;";
          if (window.helper != null) {
            if (!this.structure.lp.undersized) {
              window.helper.attr("opacity", 0.3);
            } else {
              window.helper.attr("opacity", 0);
            }
          }
        }
      }
      if (this.feapad != null) {
        this.feapad.load(this.structure, genhelper = false);
        this.feapad.sketch.updateDrawing();
        this.feapad.sketch.fea();
        this.links.attr("stroke", "#9c7b70").attr("stroke-dasharray", null);
        return this.feapad.sketch.defaultZoom();
      } else {
        if (!window.tool.autocolor && this.height > 100) {
          this.showforce = false;
          this.rect.attr("fill", "rgba(255,255,255,1)").attr("stroke", "#2eabe2");
          this.baseLine.attr("stroke", 0);
        }
        return this.links.attr("stroke", function(d) {
          if (d.F > 1e-3) {
            return colormap(d.F / d.size);
          } else {
            return "#9c7b70";
          }
        }).attr("stroke-dasharray", function(d) {
          if (d.F > 1e-3) {
            return null;
          } else {
            return 10 / _this.drawscale + "," + 10 / _this.drawscale;
          }
        });
      }
    };

    Sketch.prototype.slowDraw = function() {
      var w,
        _this = this;
      this.structure.solve();
      this.structure.solvegrad(this.selectedNodes);
      w = this.structure.nodeList.length / this.structure.lp.obj;
      if (window.tool.autocolor) {
        this.fea();
      }
      this.dragline.attr("stroke-width", 10 / this.drawscale).attr("stroke-dasharray", 10 / this.drawscale + "," + 10 / this.drawscale);
      this.links.attr("x1", function(d) {
        return d.source.x;
      }).attr("x2", function(d) {
        return d.target.x;
      }).attr("y1", function(d) {
        return d.source.y;
      }).attr("y2", function(d) {
        return d.target.y;
      }).transition().duration(80).ease("elastic").attr("stroke-opacity", function(d) {
        return 0.9 + 0.1 * (_this.selectedLinks.indexOf(d) + 1 > 0);
      }).duration(80).ease("elastic").attr("stroke-width", function(d) {
        if (d.size > 1e-3) {
          return sqrt(d.size / 10);
        } else {
          return 1;
        }
      });
      this.selectablelinks.attr("x1", function(d) {
        return d.source.x;
      }).attr("x2", function(d) {
        return d.target.x;
      }).attr("y1", function(d) {
        return d.source.y;
      }).attr("y2", function(d) {
        return d.target.y;
      }).classed("selected", function(d) {
        return _this.selectedLinks.indexOf(d) + 1;
      }).transition().duration(80).ease("elastic").attr("stroke-width", function(d) {
        return max(2, 0.75 + sqrt(d.size / 10));
      });
      this.nodes.attr("cx", function(d) {
        return d.x;
      }).attr("cy", function(d) {
        return d.y;
      }).classed("fixed", function(d) {
        return d.fixed.x || d.fixed.y;
      }).classed("immovable", function(d) {
        return d.immovable === true;
      }).classed("selected", function(d) {
        return _this.selectedNodes.indexOf(d) + 1;
      }).transition().duration(80).ease("elastic").attr("r", function(d) {
        return _this.nodeSize / _this.drawscale * (_this.selectedNodes.indexOf(d) + 1 && !(d.immovable && _this.easel.currentTool.dontSelectImmovable) ? 2 : 1);
      });
      this.fixed.attr("d", function(d) {
        var isc;
        isc = _this.nodeSize * 3.1 / 9 / _this.drawscale;
        return "M " + (-5 * isc + d.x) + "," + (-3 * isc + d.y) + "\nl " + (5 * isc) + "," + (8.6 * isc) + "\nl " + (5 * isc) + "," + (-8.6 * isc) + " Z";
      }).classed("selected", function(d) {
        return _this.selectedNodes.indexOf(d) + 1 && _this.easel.currentTool.dontSelectImmovable;
      });
      this.forces.attr("x2", function(d) {
        return d.x;
      }).attr("x1", function(d) {
        return d.x - d.force.x / 4;
      }).attr("y2", function(d) {
        return d.y;
      }).attr("y1", function(d) {
        return d.y - d.force.y / 4;
      }).attr("stroke-width", function(d) {
        var f;
        if (!d.fixed.y && dist((function() {
          var _ref1, _results;
          _ref1 = d.force;
          _results = [];
          for (d in _ref1) {
            f = _ref1[d];
            _results.push(f);
          }
          return _results;
        })()) > 0) {
          return 8 / _this.drawscale * _this.showforce;
        } else {
          return 0;
        }
      });
      return this.grads.attr("x1", function(d) {
        return d.x;
      }).attr("x2", function(d) {
        return d.x + 1000 / _this.drawscale * d.grad.x * w;
      }).attr("y1", function(d) {
        return d.y;
      }).attr("y2", function(d) {
        return d.y + 1000 / _this.drawscale * d.grad.y * w;
      }).attr("stroke-width", function(d) {
        var l;
        if (d.immovable === true) {
          return 0;
        } else if (50 / _this.drawscale * dist((function() {
          var _ref1, _results;
          _ref1 = d.grad;
          _results = [];
          for (d in _ref1) {
            l = _ref1[d];
            _results.push(l);
          }
          return _results;
        })()) * w > 0.125) {
          return 10 / _this.drawscale * (window.tool.showgrad && (_this.selectedNodes.indexOf(d) >= 0));
        } else {
          return 0;
        }
      });
    };

    Sketch.prototype.quickDraw = function() {
      var w,
        _this = this;
      this.structure.solve();
      this.structure.solvegrad(this.selectedNodes);
      this.resize();
      w = this.structure.nodeList.length / this.structure.lp.obj;
      this.dragline.attr("stroke-width", 10 / this.drawscale).attr("stroke-dasharray", 10 / this.drawscale + "," + 10 / this.drawscale);
      this.links.attr("x1", function(d) {
        return d.source.x;
      }).attr("x2", function(d) {
        return d.target.x;
      }).attr("y1", function(d) {
        return d.source.y;
      }).attr("y2", function(d) {
        return d.target.y;
      });
      this.selectablelinks.attr("x1", function(d) {
        return d.source.x;
      }).attr("x2", function(d) {
        return d.target.x;
      }).attr("y1", function(d) {
        return d.source.y;
      }).attr("y2", function(d) {
        return d.target.y;
      });
      this.nodes.attr("cx", function(d) {
        return d.x;
      }).attr("cy", function(d) {
        return d.y;
      });
      this.forces.attr("x2", function(d) {
        return d.x;
      }).attr("x1", function(d) {
        return d.x - d.force.x / 4;
      }).attr("y2", function(d) {
        return d.y;
      }).attr("y1", function(d) {
        return d.y - d.force.y / 4;
      });
      return this.grads.attr("x1", function(d) {
        return d.x;
      }).attr("x2", function(d) {
        return d.x + 1000 / _this.drawscale * d.grad.x * w;
      }).attr("y1", function(d) {
        return d.y;
      }).attr("y2", function(d) {
        return d.y + 1000 / _this.drawscale * d.grad.y * w;
      });
    };

    Sketch.prototype.resize = function() {
      var w,
        _this = this;
      w = this.structure.nodeList.length / this.structure.lp.obj;
      if (window.tool.autocolor) {
        this.fea();
      }
      this.links.attr("stroke-width", function(d) {
        if (d.size > 1e-3) {
          return sqrt(d.size / 10);
        } else {
          return 1;
        }
      }).classed("selected", function(d) {
        return _this.selectedLinks.indexOf(d) + 1;
      });
      this.selectablelinks.attr("stroke-width", function(d) {
        return max(2, 0.75 + sqrt(d.size / 10));
      }).classed("selected", function(d) {
        return _this.selectedLinks.indexOf(d) + 1;
      });
      this.nodes.classed("selected", function(d) {
        return _this.selectedNodes.indexOf(d) + 1;
      }).attr("r", function(d) {
        return _this.nodeSize / _this.drawscale * (_this.selectedNodes.indexOf(d) + 1 && !(d.immovable && _this.easel.currentTool.dontSelectImmovable) ? 2 : 1);
      });
      this.fixed.attr("d", function(d) {
        var isc;
        isc = _this.nodeSize * 3.1 / 9 / _this.drawscale;
        return "M " + (-5 * isc + d.x) + "," + (-3 * isc + d.y) + "\nl " + (5 * isc) + "," + (8.6 * isc) + "\nl " + (5 * isc) + "," + (-8.6 * isc) + " Z";
      }).classed("selected", function(d) {
        return _this.selectedNodes.indexOf(d) + 1 && _this.easel.currentTool.dontSelectImmovable;
      });
      this.forces.attr("stroke-width", function(d) {
        var f;
        if (!d.fixed.y && dist((function() {
          var _ref1, _results;
          _ref1 = d.force;
          _results = [];
          for (d in _ref1) {
            f = _ref1[d];
            _results.push(f);
          }
          return _results;
        })()) > 0) {
          return 8 / _this.drawscale * _this.showforce;
        } else {
          return 0;
        }
      });
      return this.grads.attr("stroke-width", function(d) {
        var dim, l;
        if (d.immovable === true) {
          return 0;
        } else if (d.grad.x === 1000000000) {
          return 0;
        } else if (50 / _this.drawscale * dist((function() {
          var _ref1, _results;
          _ref1 = d.grad;
          _results = [];
          for (dim in _ref1) {
            l = _ref1[dim];
            _results.push(l);
          }
          return _results;
        })()) * w > 0.125) {
          return 10 / _this.drawscale * (window.tool.showgrad && (_this.selectedNodes.indexOf(d) >= 0));
        } else {
          return 0;
        }
      });
    };

    Sketch.prototype.animateSelection = function() {
      var w,
        _this = this;
      this.structure.solvegrad(this.selectedNodes);
      w = this.structure.nodeList.length / this.structure.lp.obj;
      this.fixed.classed("selected", function(d) {
        return _this.selectedNodes.indexOf(d) + 1 && _this.easel.currentTool.dontSelectImmovable;
      });
      this.selectablelinks.attr("stroke-width", function(d) {
        return max(2, 0.75 + sqrt(d.size / 10));
      }).classed("selected", function(d) {
        return _this.selectedLinks.indexOf(d) + 1;
      });
      this.nodes.classed("selected", function(d) {
        return _this.selectedNodes.indexOf(d) + 1;
      }).transition().duration(80).attr("r", function(d) {
        return _this.nodeSize / _this.drawscale * (_this.selectedNodes.indexOf(d) + 1 && !(d.immovable && _this.easel.currentTool.dontSelectImmovable) ? 2 : 1);
      });
      return this.grads.attr("x1", function(d) {
        return d.x;
      }).attr("y1", function(d) {
        return d.y;
      }).attr("x2", function(d) {
        return d.x;
      }).attr("y2", function(d) {
        return d.y;
      }).attr("stroke-width", 0).transition().duration(80).attr("x2", function(d) {
        return d.x + 1000 / _this.drawscale * d.grad.x * w;
      }).attr("y2", function(d) {
        return d.y + 1000 / _this.drawscale * d.grad.y * w;
      }).attr("stroke-width", function(d) {
        var dim, l;
        if (d.immovable === true) {
          return 0;
        } else if (d.grad.x === 1000000000) {
          return 0;
        } else if (50 / _this.drawscale * dist((function() {
          var _ref1, _results;
          _ref1 = d.grad;
          _results = [];
          for (dim in _ref1) {
            l = _ref1[dim];
            _results.push(l);
          }
          return _results;
        })()) * w > 0.125) {
          return 10 / _this.drawscale * (window.tool.showgrad && (_this.selectedNodes.indexOf(d) >= 0));
        } else {
          return 0;
        }
      });
    };

    return Sketch;

  })();

  window.tacit.Sketch = Sketch;

}).call(this);
